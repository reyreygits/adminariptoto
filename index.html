<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ARIPTOTO - Admin Panel</title>

<!-- Firebase (compat mode) -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<style>
  body { font-family: Arial, sans-serif; background: #0a0f1c; color: white; margin: 0; padding: 0; }
  header { background: #111a33; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
  .logo { font-size: 24px; font-weight: bold; color: #FFD700; }
  .search-bar, .login-bar { margin: 20px; display: flex; gap: 10px; flex-wrap: wrap; }
  .search-bar input, .login-bar input { padding: 8px; border-radius: 6px; border: none; width: 300px; font-size: 14px; }
  .search-bar button, .login-bar button { padding: 8px 15px; background: #FFD700; color: #000; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
  table { width: 95%; margin: 20px auto; border-collapse: collapse; background: #1a1f33; border-radius: 8px; overflow: hidden; }
  th, td { padding: 10px; text-align: center; border: 1px solid #333; font-size: 14px; }
  th { background: #222; color: #FFD700; }
  td { background: #2a2a2a; }
  input.editable { width: 120px; padding: 6px; border-radius: 4px; border: none; text-align: center; background: #444; color: white; }
  .btn-action { padding: 6px 10px; margin: 2px; border-radius: 4px; cursor: pointer; border: none; font-weight: bold; font-size: 13px; }
  .btn-delete { background: #ff4444; color: white; }
  .btn-approve { background: #00cc66; color: white; }
  .btn-reject { background: #ff6666; color: white; }
  .btn-small { padding: 4px 8px; font-size: 12px; }
  .pagination { text-align: center; margin-bottom: 30px; }
  .pagination button { padding: 8px 15px; margin: 5px; border-radius: 6px; background: #FFD700; border: none; color: #000; font-weight: bold; cursor: pointer; }
  .status-badge { padding:4px 8px; border-radius:6px; font-weight:bold; }
  .status-pending { background: #ffcc00; color: #000; }
  .status-approved { background: #00cc66; color: #000; }
  .status-rejected { background: #ff4444; color: #fff; }
  .container { max-width:1200px; margin:0 auto; }
  h2 { margin-left: 20px; margin-top: 30px; border-left: 4px solid #FFD700; padding-left: 10px; }
  .top-right { display:flex; gap:10px; align-items:center; }
  .info { font-size:13px; color:#ccc; }
  .small-muted { color:#999; font-size:12px; }
  .admin-badge { padding:4px 8px; background:#333; border-radius:6px; color:#FFD700; font-weight:bold; }
</style>
</head>
<body>
<header>
  <div class="logo">ARIPTOTO - Admin Panel</div>
  <div class="top-right">
    <div id="loggedInfo" class="info">Belum login</div>
    <button id="logoutBtn" style="display:none;" class="btn-action btn-small" onclick="logoutAdmin()">Logout</button>
  </div>
</header>

<!-- Login -->
<div class="login-bar" id="loginSection">
  <input type="text" id="adminID" placeholder="Admin ID (contoh: admin1)" />
  <input type="password" id="adminPass" placeholder="Password" />
  <button onclick="loginAdmin()">üîê Login</button>
  <button onclick="ensureSampleAdmins()">‚öôÔ∏è Buat contoh admin (admin1/admin2)</button>
  <div class="small-muted">Gunakan data admin yang ada di collection <b>admins</b> Firestore</div>
</div>

<!-- Main -->
<div class="container" id="dataSection" style="display:none;">
  <div class="search-bar">
    <input type="text" id="searchInput" placeholder="Cari UserID / Nama Rekening / No Rekening" onkeydown="if(event.key==='Enter') loadAdminData()">
    <button onclick="loadAdminData()">üîç Cari / Refresh</button>
    <button onclick="loadAdminData()">üîÑ Refresh</button>
  </div>

  <h2>üìã Users List</h2>
  <table id="usersTable">
    <thead>
      <tr>
        <th>UserID</th>
        <th>Password</th>
        <th>Nama Rekening</th>
        <th>No Rekening</th>
        <th>Bank</th>
        <th>Phone</th>
        <th>Balance</th>
        <th>Aksi</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <div class="pagination">
    <button onclick="prevPage()">‚èÆÔ∏è Sebelumnya</button>
    <span id="pageInfo" class="small-muted"></span>
    <button onclick="nextPage()">‚è≠Ô∏è Berikutnya</button>
  </div>

  <h2>üí≥ Deposit List</h2>
  <table id="depositsTable">
    <thead>
      <tr>
        <th>DocID</th>
        <th>UserID</th>
        <th>Amount</th>
        <th>Status</th>
        <th>Approved By</th>
        <th>Created At</th>
        <th>Aksi</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <div class="pagination" id="depPagination"></div>

  <h2>üèß Withdraw List</h2>
  <table id="withdrawsTable">
    <thead>
      <tr>
        <th>DocID</th>
        <th>UserID</th>
        <th>Amount</th>
        <th>Status</th>
        <th>Approved By</th>
        <th>Created At</th>
        <th>Aksi</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <div class="pagination" id="wdPagination"></div>

  <h2>üëÆ Admin List (Firestore)</h2>
  <table id="adminsTable">
    <thead>
      <tr><th>AdminID</th><th>Password</th><th>Aksi</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
/* ====== FIREBASE INIT ====== */
const firebaseConfig = {
  apiKey: "AIzaSyBC8UXFcrJaxMsJsTQgnqaaNvgsAVz0vOE",
  authDomain: "ariptoto-web.firebaseapp.com",
  projectId: "ariptoto-web",
  storageBucket: "ariptoto-web.appspot.com",
  messagingSenderId: "129200594109",
  appId: "1:129200594109:web:50f7f4ce89a384211b2bd4"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ====== GLOBALS ====== */
let usersData = [];
let currentPage = 1;
const usersPerPage = 12;
let currentAdmin = null;

/* ====== HELPERS ====== */
function fmtDate(ts){
  if(!ts) return '';
  try{
    if(ts.toDate) return ts.toDate().toLocaleString();
    return new Date(ts).toLocaleString();
  }catch(e){ return String(ts); }
}

/* ====== ADMIN LOGIN ====== */
async function loginAdmin(){
  const id = document.getElementById('adminID').value.trim();
  const pass = document.getElementById('adminPass').value.trim();
  if(!id || !pass) return alert('Isi ID dan Password');
  try{
    const doc = await db.collection('admins').doc(id).get();
    if(!doc.exists) return alert('Admin tidak ditemukan di Firestore');
    const data = doc.data();
    if(data.password !== pass) return alert('Password salah');
    currentAdmin = id;
    document.getElementById('loggedInfo').innerText = 'Login sebagai: ' + currentAdmin;
    document.getElementById('logoutBtn').style.display = 'inline-block';
    document.getElementById('loginSection').style.display = 'none';
    document.getElementById('dataSection').style.display = 'block';
    await loadAdminData();
    alert('‚úÖ Login sukses sebagai ' + currentAdmin);
  }catch(e){
    console.error(e);
    alert('Gagal login (cek console)');
  }
}

function logoutAdmin(){
  currentAdmin = null;
  document.getElementById('loggedInfo').innerText = 'Belum login';
  document.getElementById('logoutBtn').style.display = 'none';
  document.getElementById('loginSection').style.display = 'flex';
  document.getElementById('dataSection').style.display = 'none';
}

/* Buat contoh admin jika belum ada (admin1/admin2) */
async function ensureSampleAdmins(){
  const sample = [
    { id: 'admin1', password: 'asd123' },
    { id: 'admin2', password: 'asd123' }
  ];
  try{
    for(const s of sample){
      const d = await db.collection('admins').doc(s.id).get();
      if(!d.exists){
        await db.collection('admins').doc(s.id).set({ password: s.password, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
      }
    }
    alert('‚úÖ Contoh admin siap (admin1/admin2). Periksa collection "admins" di Firestore.');
    if(currentAdmin) loadAdminsList();
  }catch(e){ console.error(e); alert('Gagal membuat contoh admin'); }
}

/* ====== LOAD USERS DATA ====== */
async function loadAdminData(){
  const searchText = document.getElementById('searchInput').value.trim().toLowerCase();
  const usersRef = db.collection('users').orderBy('createdAt', 'desc');
  let query = usersRef.limit(100);

  if(searchText){
    // Kita akan filter secara manual karena firestore tidak bisa query OR multi-field dengan mudah
    const snapshot = await query.get();
    usersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).filter(u => {
      if(!u) return false;
      if(u.id.toLowerCase().includes(searchText)) return true;
      if(u.namaRekening && u.namaRekening.toLowerCase().includes(searchText)) return true;
      if(u.noRekening && u.noRekening.toLowerCase().includes(searchText)) return true;
      return false;
    });
  }else{
    const snapshot = await query.get();
    usersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
  }

  currentPage = 1;
  renderUsersTable();
  loadDepositsData();
  loadWithdrawsData();
  loadAdminsList();
}

/* Render tabel users dengan paging */
function renderUsersTable(){
  const tbody = document.querySelector('#usersTable tbody');
  tbody.innerHTML = '';
  if(usersData.length === 0){
    tbody.innerHTML = '<tr><td colspan="8">Tidak ada data user ditemukan</td></tr>';
    document.getElementById('pageInfo').innerText = '';
    return;
  }

  const start = (currentPage-1)*usersPerPage;
  const end = start + usersPerPage;
  const pageData = usersData.slice(start, end);

  for(const user of pageData){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${user.id}</td>
      <td><input class="editable" type="text" value="${user.password||''}" onchange="updateUserField('${user.id}', 'password', this.value)" /></td>
      <td><input class="editable" type="text" value="${user.namaRekening||''}" onchange="updateUserField('${user.id}', 'namaRekening', this.value)" /></td>
      <td><input class="editable" type="text" value="${user.noRekening||''}" onchange="updateUserField('${user.id}', 'noRekening', this.value)" /></td>
      <td><input class="editable" type="text" value="${user.bank||''}" onchange="updateUserField('${user.id}', 'bank', this.value)" /></td>
      <td><input class="editable" type="text" value="${user.phone||''}" onchange="updateUserField('${user.id}', 'phone', this.value)" /></td>
      <td><input class="editable" type="number" value="${user.balance||0}" onchange="updateUserField('${user.id}', 'balance', Number(this.value))" /></td>
      <td><button class="btn-action btn-delete" onclick="deleteUser('${user.id}')">Hapus</button></td>
    `;
    tbody.appendChild(tr);
  }
  const totalPages = Math.ceil(usersData.length / usersPerPage);
  document.getElementById('pageInfo').innerText = `Halaman ${currentPage} dari ${totalPages}`;
}

function updateUserField(id, field, value){
  db.collection('users').doc(id).update({ [field]: value }).then(() => {
    console.log(`User ${id} updated: ${field}=${value}`);
  }).catch(console.error);
}

function deleteUser(id){
  if(!confirm(`Yakin hapus user ${id}?`)) return;
  db.collection('users').doc(id).delete().then(() => {
    alert(`User ${id} dihapus`);
    loadAdminData();
  }).catch(console.error);
}

function nextPage(){
  const totalPages = Math.ceil(usersData.length / usersPerPage);
  if(currentPage < totalPages){
    currentPage++;
    renderUsersTable();
  }
}
function prevPage(){
  if(currentPage > 1){
    currentPage--;
    renderUsersTable();
  }
}

/* ====== LOAD DEPOSITS ====== */
async function loadDepositsData(){
  const snapshot = await db.collection('deposits').orderBy('createdAt', 'desc').limit(30).get();
  const tbody = document.querySelector('#depositsTable tbody');
  tbody.innerHTML = '';
  if(snapshot.empty){
    tbody.innerHTML = '<tr><td colspan="7">Tidak ada data deposit</td></tr>';
    return;
  }
  snapshot.docs.forEach(doc => {
    const d = doc.data();
    const tr = document.createElement('tr');
    const statusClass = d.status === 'approved' ? 'status-approved' : d.status === 'rejected' ? 'status-rejected' : 'status-pending';
    tr.innerHTML = `
      <td>${doc.id}</td>
      <td>${d.userId || ''}</td>
      <td>${d.amount || 0}</td>
      <td><span class="status-badge ${statusClass}">${d.status || 'pending'}</span></td>
      <td>${d.approvedBy || ''}</td>
      <td>${fmtDate(d.createdAt)}</td>
      <td>
        ${d.status === 'pending' && currentAdmin ? `
          <button class="btn-action btn-approve" onclick="approveDeposit('${doc.id}')">Approve</button>
          <button class="btn-action btn-reject" onclick="rejectDeposit('${doc.id}')">Reject</button>
        ` : ''}
      </td>
    `;
    tbody.appendChild(tr);
  });
}

async function approveDeposit(docId){
  if(!currentAdmin) return alert('Login dulu');
  if(!confirm(`Approve deposit ${docId}?`)) return;
  await db.collection('deposits').doc(docId).update({ status: 'approved', approvedBy: currentAdmin });
  alert('Deposit approved');
  loadDepositsData();
}
async function rejectDeposit(docId){
  if(!currentAdmin) return alert('Login dulu');
  if(!confirm(`Reject deposit ${docId}?`)) return;
  await db.collection('deposits').doc(docId).update({ status: 'rejected', approvedBy: currentAdmin });
  alert('Deposit rejected');
  loadDepositsData();
}

/* ====== LOAD WITHDRAWS ====== */
async function loadWithdrawsData(){
  const snapshot = await db.collection('withdraws').orderBy('createdAt', 'desc').limit(30).get();
  const tbody = document.querySelector('#withdrawsTable tbody');
  tbody.innerHTML = '';
  if(snapshot.empty){
    tbody.innerHTML = '<tr><td colspan="7">Tidak ada data withdraw</td></tr>';
    return;
  }
  snapshot.docs.forEach(doc => {
    const d = doc.data();
    const tr = document.createElement('tr');
    const statusClass = d.status === 'approved' ? 'status-approved' : d.status === 'rejected' ? 'status-rejected' : 'status-pending';
    tr.innerHTML = `
      <td>${doc.id}</td>
      <td>${d.userId || ''}</td>
      <td>${d.amount || 0}</td>
      <td><span class="status-badge ${statusClass}">${d.status || 'pending'}</span></td>
      <td>${d.approvedBy || ''}</td>
      <td>${fmtDate(d.createdAt)}</td>
      <td>
        ${d.status === 'pending' && currentAdmin ? `
          <button class="btn-action btn-approve" onclick="approveWithdraw('${doc.id}')">Approve</button>
          <button class="btn-action btn-reject" onclick="rejectWithdraw('${doc.id}')">Reject</button>
        ` : ''}
      </td>
    `;
    tbody.appendChild(tr);
  });
}

async function approveWithdraw(docId){
  if(!currentAdmin) return alert('Login dulu');
  if(!confirm(`Approve withdraw ${docId}?`)) return;
  await db.collection('withdraws').doc(docId).update({ status: 'approved', approvedBy: currentAdmin });
  alert('Withdraw approved');
  loadWithdrawsData();
}
async function rejectWithdraw(docId){
  if(!currentAdmin) return alert('Login dulu');
  if(!confirm(`Reject withdraw ${docId}?`)) return;
  await db.collection('withdraws').doc(docId).update({ status: 'rejected', approvedBy: currentAdmin });
  alert('Withdraw rejected');
  loadWithdrawsData();
}

/* ====== LOAD ADMINS LIST ====== */
async function loadAdminsList(){
  const snapshot = await db.collection('admins').get();
  const tbody = document.querySelector('#adminsTable tbody');
  tbody.innerHTML = '';
  if(snapshot.empty){
    tbody.innerHTML = '<tr><td colspan="3">Tidak ada data admin</td></tr>';
    return;
  }
  snapshot.docs.forEach(doc => {
    const d = doc.data();
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${doc.id}</td>
      <td>${d.password || ''}</td>
      <td>
        <button class="btn-action btn-delete" onclick="deleteAdmin('${doc.id}')">Hapus</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

async function deleteAdmin(id){
  if(!confirm(`Yakin hapus admin ${id}?`)) return;
  await db.collection('admins').doc(id).delete();
  alert(`Admin ${id} dihapus`);
  loadAdminsList();
}

/* ====== START ====== */
window.onload = () => {
  // Jika sudah login pakai session/localstorage bisa dibuat disini (tidak saya implementasikan)
};
</script>

</body>
</html>
