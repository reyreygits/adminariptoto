<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin ARIPTOTO</title>
<style>
  body {
    background: #0a0f1c;
    color: white;
    font-family: Arial, sans-serif;
    padding: 20px;
  }
  h1 {
    color: #FFD700;
  }
  label, input, select, button {
    display: block;
    margin: 10px 0;
    font-size: 16px;
  }
  input, select {
    padding: 8px;
    border-radius: 5px;
    border: none;
    width: 250px;
  }
  button {
    padding: 10px 20px;
    background: #ffcc00;
    color: black;
    font-weight: bold;
    border-radius: 5px;
    border: none;
    cursor: pointer;
    width: fit-content;
  }
  button:hover {
    background: #ffaa00;
  }
  .user-list {
    margin: 20px 0;
    max-height: 300px;
    overflow-y: auto;
    background: #222;
    border-radius: 5px;
    padding: 10px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    color: white;
  }
  th, td {
    border: 1px solid #444;
    padding: 8px;
    text-align: left;
  }
  th {
    background-color: #333;
  }
  tr:hover {
    background-color: #444;
    cursor: pointer;
  }
  .message {
    margin: 10px 0;
    font-weight: bold;
  }
</style>
</head>
<body>

<h1>Admin Panel ARIPTOTO</h1>

<div>
  <h3>Daftar User</h3>
  <div id="userList" class="user-list"></div>
</div>

<div>
  <h3>Kelola User</h3>
  <label>User ID:</label>
  <input type="text" id="adminUserId" readonly />

  <label>Reset Password (isi password baru):</label>
  <input type="password" id="adminResetPass" placeholder="Password baru" />

  <label>Tambah Saldo (Rp):</label>
  <input type="number" id="adminAddBalance" placeholder="Jumlah tambah saldo" min="0" />

  <label>Tarik Saldo (Rp):</label>
  <input type="number" id="adminWithdrawBalance" placeholder="Jumlah tarik saldo" min="0" />

  <label>Ubah Nama Rekening:</label>
  <input type="text" id="adminRekName" placeholder="Nama Rekening Baru" />

  <label>Ubah No. Rekening:</label>
  <input type="text" id="adminRekNum" placeholder="Nomor Rekening Baru" />

  <label>Ubah No. HP:</label>
  <input type="text" id="adminPhone" placeholder="Nomor HP Baru" />

  <label>Ubah Bank:</label>
  <select id="adminBank">
    <option value="">-- Pilih Bank / Eâ€‘Wallet --</option>
    <option>Bank BCA</option>
    <option>Bank BNI</option>
    <option>Bank BRI</option>
    <option>Bank Mandiri</option>
    <option>DANA</option>
    <option>OVO</option>
    <option>Gopay</option>
    <option>ShopeePay</option>
  </select>

  <button onclick="saveUserChanges()">Simpan Perubahan</button>

  <div class="message" id="adminMessage"></div>
</div>

<script>
// ======= Simulasi "database" pakai localStorage =======
const STORAGE_KEY = 'ariptoto_users';

function loadUsers() {
  let data = localStorage.getItem(STORAGE_KEY);
  if (!data) {
    // Inisialisasi dengan data contoh jika belum ada
    const defaultUsers = {
      'arip123': {
        password: 'aripPass',
        balance: 1000000,
        rekName: 'Arip Toto',
        rekNum: '1234567890',
        phone: '08123456789',
        bank: 'Bank BCA',
      },
      'user2': {
        password: 'passuser2',
        balance: 500000,
        rekName: 'User Dua',
        rekNum: '9876543210',
        phone: '08987654321',
        bank: 'Bank Mandiri',
      }
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(defaultUsers));
    return defaultUsers;
  }
  return JSON.parse(data);
}

function saveUsers(users) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(users));
}

// Data user
let users = loadUsers();

const userListDiv = document.getElementById('userList');
const adminUserId = document.getElementById('adminUserId');
const adminResetPass = document.getElementById('adminResetPass');
const adminAddBalance = document.getElementById('adminAddBalance');
const adminWithdrawBalance = document.getElementById('adminWithdrawBalance');
const adminRekName = document.getElementById('adminRekName');
const adminRekNum = document.getElementById('adminRekNum');
const adminPhone = document.getElementById('adminPhone');
const adminBank = document.getElementById('adminBank');
const adminMessage = document.getElementById('adminMessage');

let selectedUser = null;

function refreshUserList() {
  users = loadUsers(); // refresh data dari storage
  userListDiv.innerHTML = '';
  const table = document.createElement('table');

  const header = document.createElement('tr');
  ['User ID', 'Nama Rekening', 'No. Rekening', 'Bank', 'Saldo (Rp)'].forEach(text => {
    const th = document.createElement('th');
    th.textContent = text;
    header.appendChild(th);
  });
  table.appendChild(header);

  Object.keys(users).forEach(userId => {
    const user = users[userId];
    const tr = document.createElement('tr');
    tr.onclick = () => selectUser(userId);

    tr.innerHTML = `
      <td>${userId}</td>
      <td>${user.rekName}</td>
      <td>${user.rekNum}</td>
      <td>${user.bank}</td>
      <td>${user.balance.toLocaleString('id-ID')}</td>
    `;
    table.appendChild(tr);
  });

  userListDiv.appendChild(table);
}

function selectUser(userId) {
  selectedUser = userId;
  const u = users[userId];
  adminUserId.value = userId;
  adminResetPass.value = '';
  adminAddBalance.value = '';
  adminWithdrawBalance.value = '';
  adminRekName.value = u.rekName;
  adminRekNum.value = u.rekNum;
  adminPhone.value = u.phone || '';
  adminBank.value = u.bank || '';
  adminMessage.textContent = '';
}

function saveUserChanges() {
  if (!selectedUser) {
    adminMessage.style.color = 'red';
    adminMessage.textContent = 'Pilih user terlebih dahulu.';
    return;
  }
  const u = users[selectedUser];

  // Update password jika ada input
  if (adminResetPass.value.trim() !== '') {
    u.password = adminResetPass.value.trim();
  }

  // Update balance
  let addBal = Number(adminAddBalance.value);
  if (!isNaN(addBal) && addBal > 0) {
    u.balance += addBal;
  }

  let withdrawBal = Number(adminWithdrawBalance.value);
  if (!isNaN(withdrawBal) && withdrawBal > 0) {
    if (withdrawBal <= u.balance) {
      u.balance -= withdrawBal;
    } else {
      adminMessage.style.color = 'red';
      adminMessage.textContent = 'Saldo tidak cukup untuk penarikan.';
      return;
    }
  }

  // Update rekName, rekNum, phone, bank
  u.rekName = adminRekName.value.trim();
  u.rekNum = adminRekNum.value.trim();
  u.phone = adminPhone.value.trim();
  u.bank = adminBank.value;

  saveUsers(users);
  refreshUserList();

  // Kirim update ke webset 1 (sinkronisasi) - Simulasi API call
  syncUpdateToWebset1(selectedUser, u);

  adminMessage.style.color = 'lime';
  adminMessage.textContent = 'Perubahan berhasil disimpan dan tersinkronisasi ke webset 1.';
}

function syncUpdateToWebset1(userId, userData) {
  // Simulasi fetch API ke Webset 1
  console.log(`Mengirim update user ${userId} ke webset 1...`);
  // Di implementasi asli, gunakan fetch POST/PUT ke webset 1 API
  // Contoh:
  // fetch('https://domain-webset1.com/api/updateUser/' + userId, {method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(userData)})
  // .then(...)

  // Untuk demo, kita simpan juga di localStorage untuk webset 1 agar bisa demo sinkron
  localStorage.setItem('webset1_user_' + userId, JSON.stringify(userData));
}

// API Simulasi untuk webset 1 melakukan GET, POST, PUT ke webset 2

// GET user data (misal untuk sync di webset1)
function apiGetUser(userId) {
  users = loadUsers();
  if(users[userId]) return {success:true, data: users[userId]};
  else return {success:false, message:'User tidak ditemukan'};
}

// POST user baru
function apiAddUser(userData) {
  users = loadUsers();
  if(users[userData.user]) {
    return {success:false, message:'User sudah ada'};
  }
  users[userData.user] = {
    password: userData.pass,
    balance: 0,
    rekName: userData.rekName,
    rekNum: userData.rekNum,
    phone: userData.phone,
    bank: userData.bank,
  };
  saveUsers(users);
  refreshUserList();
  return {success:true};
}

// PUT update user
function apiUpdateUser(userId, updateData) {
  users = loadUsers();
  if(!users[userId]) {
    return {success:false, message:'User tidak ditemukan'};
  }
  Object.assign(users[userId], updateData);
  saveUsers(users);
  refreshUserList();
  return {success:true};
}

// Untuk demo, override fetch agar bisa panggil fungsi API di sini jika domain sama
window.mockFetch = async function(url, options = {}) {
  // console.log('mockFetch:', url, options);
  if(url.endsWith('/api/users') && options.method === 'POST') {
    const body = JSON.parse(options.body);
    const res = apiAddUser(body);
    return {
      json: async () => res
    };
  }
  if(url.includes('/api/users/') && options.method === 'PUT') {
    const userId = url.split('/').pop();
    const body = JSON.parse(options.body);
    const res = apiUpdateUser(userId, body);
    return {
      json: async () => res
    };
  }
  if(url.includes('/api/users/') && (!options.method || options.method === 'GET')) {
    const userId = url.split('/').pop();
    const res = apiGetUser(userId);
    return {
      json: async () => res
    };
  }
  return fetch(url, options); // fallback
}

refreshUserList();
</script>

</body>
</html>
